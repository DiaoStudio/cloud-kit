# 门卫模式（Gatekeeper Pattern）

*翻译：Sekai.Xu*

[![Security](https://i-msdn.sec.s-msft.com/dynimg/IC709498.png)](https://msdn.microsoft.com/en-us/library/dn600221.aspx)  [![Design Patterns](https://i-msdn.sec.s-msft.com/dynimg/IC709485.png)](https://msdn.microsoft.com/en-us/library/dn600223.aspx)  [![Show All](https://i-msdn.sec.s-msft.com/dynimg/IC709871.png)](../)

可以使用一个专门的主机实例作为客户端和应用服务的“中间人”，以此来保护我们的应用服务，它可以进行验证，也可以过滤有问题的请求，并且在客户端和应用服务之间传递请求和数据。这样做可以为我们的系统提供一个额外的安全层，并限制了系统的易受攻击的部分。

## 现状及难题
应用程序通常通过接受并执行请求来对客户端暴露它们的功能。在云托管方案中，应用程序会作为通信结点（endpoint）暴露给客户端以供他们连接，而且通常应用程序会包含专门用于处理客户端请求的代码。这部分代码可能会对一部分或者全部请求进行身份和数据验证，并且它很有可能会访问属于这个用户的数据和其他服务。

如果一个居心叵测的用户能够侵入系统并获得访问应用程序托管环境的权限，同时他也获得了此系统采用的安全机制，比如凭证或者存储密钥，并且他也得知了这个应用程序所访问的服务和数据。那么，这个用户可能就能够获得自由地访问一些敏感信息和其他服务。

## 解决方案
为了尽量减少用户获得访问敏感信息和服务的风险，需要将暴露出去的公共通信结点与处理请求并访问数据库的代码解耦。这可以通过使用外观（façade）或者一个专门的任务实现，它负责与用户进行交互，并向处理请求的主机或任务放行请求（很有可能是通过一个解耦的接口）。图1展示了这种方式的高层架构图。

![图1 - 门卫模式的高层架构图简图](../files/en/10_Figure_1.png)  
图1 - 门卫模式的高层架构图简图

使用门卫模式可以很容易地保护数据，也可以把它当作一个用来保护应用程序所有功能的更全面的外观（façade）。以下原因十分重要：

* **受控的验证**。门卫（Gatekeeper）将验证所有请求，并直接拒绝那些没有验证通过的请求。
* **有限的风险和暴露**。门卫并不拥有可以访问存储和服务的可信主机的凭证或密钥。如果门卫被入侵了，入侵者是无法获取这些凭证或密钥的。
* **合适的安全性**。门卫运行在一个受限模式下，而应用程序的其余部分则可以在完全信任模式下运行，并在需要时可以访问存储和服务。如果门卫被入侵了，它并不能直接访问应用程序服务或者数据。

这种模式能有效地产生与传统的网络拓扑中的防火墙类似的作用。它允许门卫去检测请求并决定是否向需要执行任务的可信主机（有时候也被叫做Keymaster）放行请求。为了做出这些决定，门卫一般需要在向可信主机传递请求钱验证并去除请求内容中的危险信息。

## 问题及注意事项
在决定如何去实施这种模式时需要考虑一下几点：

* 确保门卫传递请求到的可信主机只暴露于内网或者受保护的通信结点，并且这些主机只与门卫连接。可信主机不应该暴露任何额外的通信结点或接口。
* 门卫必须运行在受限模式下。这通常意味着门卫和可信主机运行在相互隔离的托管服务或者虚拟机上。
* 门卫不应该执行任何与应用程序或者服务相关的处理，也不应该访问任何数据。它的功能只是纯粹地验证和去除请求中的有害成分。可信主机对请求可能需要执行额外的验证，但是核心的验证应该由门卫执行。
* 可能的话，在门卫和可信主机或任务之间使用一个加密信道（HTTPS，SSL或者TLS）。不过，有些托管环境可能不支持在内网通信结点间使用HTTPS协议。
* 为了实施门卫模式需要为应用程序增加额外一层架构，由于它需要额外的程序处理和网络通信，这可能会对应用程序的性能产生一定影响。
* 门卫实例可能会成为一个单点故障。为了尽量减少故障的影响，可以考虑部署额外的实例，并使用弹性机制来保证有足够的性能以支撑可用性。

## 何时能用到这个模式
这种模式非常适合于：

* 那些处理敏感信息、会暴露一些需要高度保护免受攻击的服务的应用程序，或者那些需要执行不能被干扰的关键任务操作的应用程序。
* 那些需要与主任务分别进行请求验证的分布式程序。或者需要集中进行验证以简化维护和管理

## 实例
在一个云托管方案中，这种模式可以通过将门卫角色或虚拟机与可信主机和服务解耦来实现，可以使用内部通信结点、队列或者存储来作为它们之间的通信机制。图2展示了使用内部通信结点基本原理。

![图2 - 一个门卫模式的例子：使用云服务网络和辅助角色
](../files/en/10_Figure_2.png)  
图2 - 一个门卫模式的例子：使用云服务网络和辅助角色

## 相关的设计模式和实践指南
实施门卫模式时，以下模式也可能有用：

* [Valet Key Pattern](#)。当门卫角色和可信角色互相通信时，一种非常好的做法是通过使用密钥或者令牌来限制资源的访问权限并增加安全性。Valet Key模式描述了如何使用密钥或者令牌来为客户端提供对于特定资源或服务的有限制的直接访问权限。

## 译者注

* **解决方案**部分中提到的façade原意是建筑学中的立面，在设计模式领域可能最早由四人帮提出了外观模式（Facade Pattern），故直接翻译为外观。
* 本篇中出现了endpoint，原意是终端，为了理解方便，均翻译为通信结点。

## ===TODO===
* 修改相关的设计模式和实践指南中的Valet Key模式的翻译。
* 增加相关的设计模式和实践指南中的Valet Key Pattern的链接.